export DISK_NAME=os.dmg 
export TARGET_PATH=$HOME/pcosa

fdisk $DISK_NAME

# 写boot区，定位到dbr区，写只写代码区
# fat16分区位于第1扇区（从前面的fdisk中获得），fat16的头占62字节，所以写起始偏移为1024+62=1086
# 读取起始偏移为：62字节，用于跳过boot.bin中的fat16头
# 总拷贝数量为：count=512-62=450
dd if=boot.bin of=os.dmg bs=1 conv=notrunc iseek=62 oseek=1086 count=450

hdiutil attach os.dmg -mountpoint $TARGET_PATH 
cp -v loader.bin $TARGET_PATH/loader.bin
cp -v kernel.elf $TARGET_PATH/kernel.elf
cp -v snake.elf $TARGET_PATH/snake.elf
cp -v counter.elf $TARGET_PATH/counter.elf
cp -v shell.elf $TARGET_PATH/shell.elf
hdiutil unmount $TARGET_PATH

qemu-system-i386  -m 128M -S -gdb tcp::1234,ipv4 -drive format=raw,file=os.dmg -d exec
